= 在 Air-Gapped 模式下安装 SUSE Observability Agent
:revdate: 2025-07-18
:page-revdate: {revdate}
:description: SUSE 可观察性

本文档提供了在空中加油环境中使用 Helm 图表安装 SUSE Observability Agent 的分步指南。安装过程包括在能上网的主机上准备必要的 Docker 映像和 Helm 图表，将它们传输到专用网络内的主机上，将 Docker 映像上传到专用注册表，然后部署 Helm 图表。安装代理所需的权限可在xref:/k8s-suse-rancher-prime.adoc#_required_privileges[此处]找到

== 先决条件

=== 在本地主机上（互联网访问）

* *操作系统*：Linux or MacOS
* *已安装工具*：
 ** https://www.docker.com/products/docker-desktop/[Docker]
 ** https://helm.sh/docs/intro/install/[舵夹]
 ** 从源注册表下载 Docker 镜像的脚本（本指南稍后将提供链接）。
* *互联网接入*：需要从 Quay.io 获取 Docker 映像，并从 ChartMuseum 获取 Helm 图表。

=== 在专用网络主机上

* *访问*：SSH 访问主机。
* *已安装工具*：
 ** https://www.docker.com/products/docker-desktop/[Docker]
 ** https://helm.sh/docs/intro/install/[舵夹]
 ** 从源注册表下载 Docker 镜像的脚本（本指南稍后将提供链接）。
 ** 将图像上传到私有 Docker 注册表的网络访问权限和凭证。
 ** 在目标集群上安装 Helm 图表的已配置 Kubeconfig。

== 准备 Docker 映像和 Helm 图表

在本地主机上运行以下命令，获取必要的 Docker 映像和 Helm 图表：

*将 Helm 资源库添加到本地 Helm 缓存：*

[,bash]
----
# Adding the Helm repository for the SUSE Observability Agent
helm repo add suse-observability https://charts.rancher.com/server-charts/prime/suse-observability
helm repo update
----

*获取图表的最新版本*

以下命令将从 Helm 资源库下载图表的 TGZ 压缩包：

[,bash]
----
# Downloading the chart for the SUSE Observability Agent
# The file will be named stackstate-agent-X.Y.Z.tgz
helm fetch suse-observability/suse-observability-agent
----

*获取 Bash 脚本来保存 Docker 镜像。*

[,bash]
----
# o11y-agent-get-images.sh
curl -LO https://raw.githubusercontent.com/StackVista/helm-charts/master/stable/suse-observability-agent/installation/o11y-agent-get-images.sh
# o11y-agent-save-images.sh
curl -LO https://raw.githubusercontent.com/StackVista/helm-charts/master/stable/suse-observability-agent/installation/o11y-agent-save-images.sh

# Make the scripts executable
chmod a+x o11y-agent-get-images.sh o11y-agent-save-images.sh
----

*提取和保存 Docker 映像*

[,bash]
----
# Extract the list of images from the Helm chart and save it to a file.
./o11y-agent-get-images.sh -f suse-observability-agent-X.Y.Z.tgz > o11y-agent-images.txt
----

[NOTE]
====
将`suse-observability-agent-X.Y.Z.tgz` 替换为之前下载的图表存档的实际文件名.*。
====


[,bash]
----
# Save Docker images to an archive.
# The script expects the file o11y-agent-images.txt to contain the list of images used by the SUSE Observability Agent.
# The Docker images will be saved to o11y-agent-images.tar.gz.
./o11y-agent-save-images.sh -i o11y-agent-images.txt -f o11y-agent-images.tar.gz
----

== 将所需文件复制到远程主机

必须将下列文件从本地主机复制到专用网络中的主机：

* o11y-agent-images.txt （SUSE Observability Agent 图表所需的图像列表）
* o11y-agent-images.tar.gz（包含 SUSE Observability 代理的 Docker 映像的压缩包）
* https://raw.githubusercontent.com/StackVista/helm-charts/master/stable/suse-observability-agent/installation/o11y-agent-load-images.sh[o11y-agent-load-images.sh]（将 Docker 镜像上传到注册表的 Bash 脚本）
* 之前下载的舵手图：
 ** suse-observability-agent-X.Y.Z.tgz

== 将 Docker 映像从存档恢复到私有注册中心

*将图像上传到私人注册表：*

[,bash]
----
# Load Docker images from the archive and push them to the private registry.
# Replace <private-registry> with your private registry's URL.
export DST_REGISTRY_USERNAME="..."
export DST_REGISTRY_PASSWORD="..."
./o11y-agent-load-images.sh -d registry.example.com:5043 -i o11y-agent-images.txt -f o11y-agent-images.tar.gz
----

[NOTE]
====
_注意：如果目标注册表不使用身份验证，则不得配置环境变量`DST_REGISTRY_USERNAME` 和`DST_REGISTRY_PASSWORD` ，或将其设置为空值。_
====


== 安装 SUSE Observability Agent

必须从 SUSE Observability UI 接收安装 SUSE Observability Agent 的命令。
登录实例，在左侧菜单中选择`Stackpacks` 。按`ADD NEW INSTANCE` 并填写群组名称。为了与 Rancher 正确集成，它必须与 Rancher UI 中的群集名称相同。

image::rancher-prime-agent-airgap-01.png[添加新代理]

添加实例后，用户界面将提供如何部署 Helm 图表的说明。向下滚动到`Self-hosted` 部分，复制`helm upgrade ...` 命令

image::rancher-prime-agent-airgap-02.png[获取 Helm 安装命令]

必须更新该命令才能安装气隙式安装：

* 使用`all.image.registry` 值覆盖图像注册表。
* 使用带有 Helm 图表的存档，而不是 Helm 资源库。 `suse-observability/suse-observability-agent` \-> `./suse-observability-agent-X.Y.Z.tgz`

运行命令安装 SUSE Observability Agent

[,bash]
----
helm upgrade --install \
--namespace suse-observability \
--create-namespace \
--set-string 'stackstate.apiKey'='<api-key>' \
--set-string 'stackstate.cluster.name'='<cluster-name>' \
--set-string 'stackstate.url'='https://...' \
--set 'nodeAgent.skipKubeletTLSVerify'=true \
--set-string 'all.image.registry'='registry.acme.com:5000' \
--set-string 'global.imageRegistry'='registry.acme.com:5000' \
--set-string 'global.skipSslValidation'=true \
suse-observability-agent ./suse-observability-agent-X.Y.Z.tgz
----

*验证部署*

[,bash]
----
kubectl get pod -n suse-observability
----
