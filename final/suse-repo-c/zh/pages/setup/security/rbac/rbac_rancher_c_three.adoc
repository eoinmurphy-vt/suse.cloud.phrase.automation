= Rancher RBAC
:revdate: 2025-07-10
:page-revdate: {revdate}
:description: SUSE 可观测性自托管

== 概述

SUSE Rancher Prime 可观测性扩展使用 Kubernetes RBAC 授予 SUSE 可观测性中的 Rancher 用户访问权限。
如果您不使用 Rancher，请查看 xref:/setup/security/rbac/rbac_roles.adoc[如何在独立安装中设置角色]。

[NOTE]
====
为了使 Rancher RBAC 能够正常运行，

* {stackstate-product-name} 的身份验证必须使用 xref:setup/security/authentication/oidc.adoc#_rancher[Rancher OIDC 提供程序] 进行配置。
* 该 {stackstate-product-name} 代理必须启用 RBAC 代理，并且必须使用服务令牌进行身份验证。
====

每个经过身份验证的用户都有*实例基本访问*角色，允许他们使用系统。 这些权限提供对视图、设置、指标绑定的访问，并且允许用户查看系统通知。 它们不授予对任何 {stackstate-product-name} 数据的访问权限。 为了查看任何数据，用户需要被授予额外的角色。Rancher *角色模板* 提供了两种扩展 *实例基本访问* 角色的方式：

实例角色:: 使您能够配置或个性化 {stackstate-product-name}。
作用域角色:: 授予对观察到的集群中{stackstate-product-name}数据的访问权限。

== 实例角色

您可以将 *角色模板*（用于 *实例角色*）分配给正在运行 {stackstate-product-name} 的 *项目*中的用户或用户组。如果没有明确分配实例角色给项目的成员，则他们将拥有*实例基本访问*角色的权限。

=== 具有对 {stackstate-product-name} 数据访问权限的实例角色

几个“全局”角色允许访问所有{stackstate-product-name}数据，在任何被监控的集群中。 这些角色旨在用于系统设置和系统级问题的故障排除。 对于拥有这些角色的用户，没有必要配置xref:scoped[Scoped Roles]。

实例管理员:: 授予对所有视图和权限的完全访问。
实例故障排除者:: 授予使用 SUSE 可观察性进行故障排除所需的所有权限，包括启用或禁用监视器、创建自定义视图以及使用命令行界面（CLI）的权限。
实例观察者:: 授予对 SUSE 可观察性实例中所有数据的访问权限。

=== 无法访问{stackstate-product-name}数据的实例角色

这些角色需要与*Instance Observer*角色或其中一个xref:scoped[作用域角色]结合使用（见下文）。 否则，无法访问任何 {stackstate-product-name} 数据，用户界面将显示 "No components found" 消息。 这适用于所有Rancher用户，包括用户，例如项目所有者。

实例推荐访问权限:: 授予使用 SUSE 可观察性的推荐权限。 此角色包括一些不是严格必要的权限，但提供（有限的）个性化手段{stackstate-product-name}。
实例基本访问:: 授予使用{stackstate-product-name}的最小权限。此角色不需要明确分配，并且没有*Role Template*，每个登录用户都有此角色。

您可以在下面找到分配给每个预定义 SUSE 可观察性角色的权限。有关不同权限的详细信息以及如何使用`sts`CLI 管理它们，请参见xref:/setup/security/rbac/rbac_permissions.adoc[基于角色的访问控制 (RBAC) 权限]

[tabs]
====
基本访问::
+
--
基本访问授予使用 SUSE Observability 的最低权限。与 Observer（实例、集群或项目）结合使用。
这些权限授予所有用户。

|===
|资源 |动词 

|metric-bindings |获取
|设置 |获取
|system-notifications |获取
|视图 |获取
|===

--
推荐的访问权限::
+
--
推荐访问授予的权限虽非严格必要，但能让 SUSE Observability 更加有用。它提供了一定程度的个性化。
与 Observer（实例、集群或项目）结合使用。

|===
|资源 |动词 

|api-tokens |获取
|favorite-dashboards |创建，删除
|favorite-views |创建，删除
|stackpacks |获取 
|visualization-settings |update
|===

--
观察者::
+
--
Observer 角色可访问 SUSE Observability 实例中的所有观测数据。 与*推荐访问权限*结合使用以获得更好的体验。

|===
|资源 |动词 

|拓扑 |获取
|指标 |获取
|跟踪记录 |获取
|===

--
故障排除者::
+
--
故障排除者角色可以访问SUSE可观察性中所有可用数据，并能够创建视图和启用/禁用监视器。

|===
|资源 |动词 

|代理 |获取 
|api-tokens |获取
|组件操作 |execute
|仪表板 |获取、创建、更新、删除 
|favorite-dashboards |创建，删除
|favorite-views |创建，删除
|metric-bindings |获取
|指标 |获取 
|监视器 |获取、创建、更新、删除、执行 
|通知 |获取、创建、更新、删除 
|设置 |获取 
|stackpack-configurations |获取、创建、更新、删除
|stackpacks |获取 
|system-notifications |获取
|拓扑 |获取 
|跟踪记录 |获取 
|视图 |获取、创建、更新、删除 
|visualization-settings |获取
|===

--
管理员::
+
--
管理员角色拥有所有权限。

|===
|资源 |动词 

|代理 |获取 
|api-tokens |获取
|组件操作 |execute
|仪表板 |获取、创建、更新、删除 
|favorite-dashboards |创建，删除
|favorite-views |创建，删除
|数据摄取 API 密钥 |获取、创建、更新、删除
|metric-bindings |获取
|指标 |获取 
|监视器 |获取、创建、更新、删除、执行 
|通知 |获取、创建、更新、删除 
|permissions |获取、创建、更新、删除 
|受限脚本 |execute
|service-tokens |获取、创建、更新、删除
|设置 |获取、创建、更新、删除、解锁 
|stackpack-configurations |获取、创建、更新、删除
|stackpacks |获取、创建 
|sync-data |获取、更新、删除
|system-notifications |获取
|主题消息 |获取
|拓扑 |获取 
|跟踪记录 |获取 
|视图 |获取、创建、更新、删除 
|visualization-settings |update
|===

--
====

[#scoped]
== 作用域角色

您可以将以下*角色模板*分配给受监控集群中的用户或组。 它们授予对{stackstate-product-name}来自*Cluster*中（*Project*）的数据的访问权限。

观察者:: 授予对来自*Project*中的命名空间的数据的访问权限。您可以在集群配置的*Project Membership*部分使用此项。
集群观察者:: 授予对来自*Cluster*的所有数据的访问权限。您可以在集群配置的*集群成员资格*部分中使用此模板。

这些角色中的资源对应于xref:/setup/security/rbac/rbac_permissions.adoc#_scoped_permissions[Scoped Permissions]。它们在`scope.observability.cattle.io` API组中可用（仅具有动词`get`，因为这些资源是只读的）：

* `topology` - 来自集群或命名空间的组件（部署、pod 等）
* `traces` - 来自集群或命名空间的 span
* `metrics` — 来自集群或命名空间的指标数据

请注意，日志的访问由`topology`资源控制。

通过在*Project*上授予*实例推荐访问权限*角色（该项目正在运行{stackstate-product-name}），为具有这些观察者角色的用户启用个性化。

== 自定义角色

要授予超出推荐访问的额外权限，请在Rancher中创建一个自定义项目*RoleTemplate*，继承自*SUSE Observability Instance Recommended Access*。 然后，例如，要授予查看监视器和指标图表的权限，请添加规则：

* 动词：`get`
* 资源：`metricbindings` 和 `monitors`
* ApiGroup：`instance.observability.cattle.io`

image::rancher-custom-role.png[自定义角色模板以获得更丰富的访问]

您可以指定在xref:/setup/security/rbac/rbac_permissions.adoc[RBAC 权限]中定义的任何资源和动词组合。 请注意，资源名称中的破折号（`-`）被省略，因此权限`get-metric-bindings`变为 Kubernetes RBAC资源`metricbindings`，动词为`get`。


== 查错

* 验证集群的RBAC代理是否能够与平台通信。

* xref:/setup/security/rbac/rbac_permissions.adoc#_list_subjects_for_a_user[检查用户主体]（用户和角色）。
  ** 验证 OIDC 提供者上的任何角色配置。
* xref:/setup/security/rbac/rbac_permissions.adoc#_show_granted_permissions[检查主体权限]
  ** 验证与用户匹配的相关（Cluster）RoleBinding 或 RoleBinding 是否存在，并与（Cluster）Role 或 Role 匹配。
  ** 检查（集群）角色以验证其是否授予正确的权限。
