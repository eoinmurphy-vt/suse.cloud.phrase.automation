= Sincronização de saúde
:revdate: 2025-07-10
:page-revdate: {revdate}
:description: Observabilidade do SUSE

Esta seção descreve o tópico avançado de sincronização de dados de integridade personalizados de diferentes sistemas de monitoramento para o SUSE Observability.
Esse tópico é interessante principalmente para engenheiros que desejam fazer uma integração personalizada com um sistema de monitoramento existente.
Para monitores prontos para uso, consulte xref:/use/alerting/kubernetes-monitors.adoc[aqui].

== Visão geral

A sincronização de integridade adiciona verificações de integridade existentes de sistemas de monitoramento externos aos elementos de topologia do SUSE Observability. Os dados de integridade são calculados no sistema de monitoramento externo usando seus próprios dados e regras e, em seguida, são automaticamente sincronizados e anexados aos elementos de topologia associados no SUSE Observability.

== Configurar a sincronização de integridade

A API do SUSE Observability Receiver receberá e processará automaticamente todos os dados de integridade recebidos. O SUSE Observability não exige configuração adicional para ativar a sincronização de integridade; no entanto, os dados de integridade recebidos devem corresponder ao formato JSON esperado.

Detalhes sobre como ingerir dados de saúde podem ser encontrados nas páginas a seguir:

* xref:/configure/health/send-health-data/send-health-data.adoc[Ingerir dados de saúde por meio da API do SUSE Observability Receiver]

== Pipeline de sincronização de saúde

A estrutura de sincronização de saúde funciona da seguinte forma:

* Os dados de integridade são enviados ao SUSE Observability e ingeridos por meio da API do receptor.
* Os elementos da topologia do SUSE Observability relacionados às verificações de integridade ingeridas são identificados e vinculados com base em:
 ** os identificadores de topologia obtidos durante a sincronização de topologia.
 ** o `topologyElementIdentifier` da xref:/configure/health/send-health-data/send-health-data.adoc#_json_health_payload[carga útil de saúde] ingerida.
* O SUSE Observability controla as alterações nos elementos da topologia e nas verificações de integridade para manter as informações atualizadas.

image::health-sync-pipeline.svg[Pipeline de sincronização de saúde]

=== Modelos de consistência

A sincronização de integridade do SUSE Observability depende de diferentes modelos de consistência para garantir que os dados enviados de um sistema de monitoramento externo correspondam ao que o SUSE Observability ingere e mostra. O modelo de consistência é especificado na propriedade `"health"` do xref:/configure/health/send-health-data/send-health-data.adoc#_common_json_object[objeto JSON comum] ou como um argumento na CLI do SUSE Observability quando os dados de integridade são enviados ao SUSE Observability. Os modelos compatíveis são: `REPEAT_SNAPSHOTS` e `TRANSACTIONAL_INCREMENTS`.
[tabs]
====
Modelo de repetição de instantâneos::
+
--
O modelo de consistência `REPEAT_SNAPSHOTS` funciona com instantâneos periódicos e completos de todas as verificações em um sistema de monitoramento externo. O SUSE Observability mantém o controle das verificações em cada instantâneo recebido e decide se os estados de verificação externos associados precisam ser criados, atualizados ou excluídos no SUSE Observability. Por exemplo, se um estado de verificação não estiver mais presente em um snapshot. Esse modelo oferece controle total sobre quais verificações externas serão excluídas, pois todas as decisões são inferidas a partir dos instantâneos recebidos. Não há ambiguidade quanto às verificações externas que estarão presentes no SUSE Observability.

*Use esse modelo quando:* O sistema de monitoramento externo é capaz de manter o estado de quais elementos estão presentes em uma determinada janela de tempo e, portanto, pode comunicar a aparência do instantâneo completo.

*Carga útil JSON:* A xref:/configure/health/send-health-data/repeat_snapshots.adoc[carga útil de integridade Repeat Snapshots] aceita propriedades específicas para especificar quando um instantâneo é iniciado ou interrompido.
--

Modelo de incrementos transacionais::
+
--
O modelo de consistência `TRANSACTIONAL_INCREMENTS` foi projetado para ser usado em sistemas de streaming em que somente alterações incrementais são comunicadas ao SUSE Observability. Como não há repetição de dados, a consistência dos dados é mantida, assegurando que a entrega pelo menos uma vez seja garantida em todo o pipeline. Para detectar se algum dado está faltando, o SUSE Observability exige que tanto um ponto de verificação quanto o ponto de verificação anterior sejam comunicados juntamente com o `check_states`. Esse modelo exige um controle rigoroso de todo o pipeline para garantir que não haja perda de dados.

*Use esse modelo quando:* O sistema de monitoramento externo não tem acesso ao estado total das verificações externas, mas trabalha apenas com uma abordagem baseada em eventos.

*Carga útil JSON:* Os metadados `repeat_interval` e `expire_interval` não são relevantes para a xref:/configure/health/send-health-data/transactional_increments.adoc[carga útil de integridade dos Incrementos Transacionais], pois não há periodicidade predefinida nos dados.

--
====

=== Fluxo e subfluxo de saúde

Os sistemas de monitoramento externos enviam dados de integridade para o SUSE Observability Receiver em um fluxo de integridade. Cada fluxo de saúde tem pelo menos um subfluxo com verificações de saúde.

==== Fluxo de saúde

O fluxo de saúde identifica exclusivamente a sincronização de saúde e define os limites dentro dos quais os estados de verificação de saúde devem ser processados em conjunto.

==== Subfluxo

Os subfluxos contêm os dados de verificação de integridade que são processados pelo SUSE Observability. Ao trabalhar com dados de integridade de um sistema de monitoramento externo distribuído, vários subfluxos podem ser configurados, cada um contendo instantâneos de integridade de um único local. Os dados em cada subfluxo são semi-independentes, mas contribuem para os estados de verificação de integridade do fluxo de integridade completo. Se um único local for responsável por relatar os estados de verificação de integridade do fluxo de integridade, você poderá omitir o endereço `sub_stream_id` do xref:/configure/health/send-health-data/send-health-data.adoc#_json_health_payload[payload de integridade]. O SUSE Observability presumirá que todas as verificações de integridade externas pertencem a um único subfluxo padrão.

=== Intervalo de repetição

A sincronização de saúde processa os dados de saúde ingeridos por subfluxo. O intervalo de repetição especificado na xref:/configure/health/send-health-data/send-health-data.adoc#_json_health_payload[carga útil de integridade] é o compromisso do sistema de monitoramento externo de enviar instantâneos completos repetidamente para manter os dados atualizados no SUSE Observability. Isso é útil para que o SUSE Observability possa informar ao usuário o quão atualizada está a sincronização de integridade.

=== Intervalo de expiração

O intervalo de expiração pode ser usado para configurar subfluxos na sincronização de integridade para excluir dados que não são mais enviados pelo sistema externo. Isso é útil no caso de a fonte de um subfluxo ser desativada e o SUSE Observability não receber mais informações sobre ela. Sem um intervalo de expiração, os dados sincronizados anteriormente ficariam permanentemente pendentes.

=== Verificar estado

O estado de verificação de integridade é calculado por um sistema de monitoramento externo e inclui todas as informações necessárias para anexá-lo a um elemento de topologia. Para poder materializá-lo e anexá-lo a um componente, é necessário atribuir o estado de integridade a um monitor específico, neste caso, um <<_external_monitor,ExternalMonitor>>.

Uma vez anexado a um elemento de topologia, o estado de verificação de integridade contribui para o estado de integridade do próprio elemento.

=== Monitor externo

Um monitor externo permite anexar os estados de integridade aos componentes e mostrar uma remediationHint nas páginas de destaque do SUSE Observability. Esse recurso precisa ser criado por meio da xref:/setup/cli/cli-sts.adoc[CLI do SUSE Observability] ou como parte de um stackpack. Aqui está um exemplo de um monitor externo:

----
    {
      "_type": "ExternalMonitor",
      "healthStreamUrn": "urn:health:kubernetes:external-health",
      "description": "Monitored by external tool.",
      "identifier": "urn:custom:external-monitor:heartbeat",
      "name": "External Monitor Heartbeat",
      "remediationHint": "",
      "tags": [
        "heartbeat"
      ]
    }
----

Cada carga útil do `ExternalMonitor` tem os seguintes detalhes:

* `_type`: O SUSE Observability precisa saber que esse é um monitor, portanto, o valor sempre precisa ser `ExternalMonitor`
* `healthStreamUrn`: Esse campo precisa corresponder ao `urn` que é enviado como parte do xref:/configure/health/send-health-data/repeat_snapshots.adoc#_json_property_health[Health Payload].
* `description`: Uma descrição do monitor externo.
* `identifier`: Um identificador do formato `urn:custom:external-monitor:....` que identifica exclusivamente o monitor externo ao atualizar sua configuração.
* `name`: O nome do monitor externo
* `remediationHint`: Uma descrição do que o usuário pode fazer quando o monitor falha. O formato é markdown.
* `tags`: Adicione tags ao monitor para ajudar a organizá-las na visão geral dos monitores de sua instância do SUSE Observability, http://your-SUSE Observability-instance/#/monitors

Veja a seguir um exemplo de como criar um `External Monitor` usando xref:/setup/cli/cli-sts.adoc[a CLI do SUSE Observability]

* Crie um novo arquivo YAML chamado `externalMonitor.yaml` e adicione esse modelo YAML a ele para criar seu próprio monitor externo.
```
nodes:
* _type: ExternalMonitor
healthStreamUrn: urn:health:sourceId:streamId
description: Monitored by external tool.
identifier: urn:custom:external-monitor:heartbeat
name: External Monitor Heartbeat
remediationHint: |-
  To remedy this issue with the deployment {{ labels.deployment }}, consider taking the following steps:
 .. Look at the logs of the pods created by the deployment
tags:
  *** heartbeat
```
* Use o cli para criar o monitor externo
```bash
sts settings apply -f externalMonitor.yaml
✅ Applied 1 setting node(s).

TYPE            | ID              | IDENTIFIER                            | NAME                    +
ExternalMonitor | 150031117290020 | urn:custom:external-monitor:heartbeat | External Monitor Heartbeat
```

== Veja também

* xref:/configure/health/send-health-data/send-health-data.adoc#_json_health_payload[Carga útil de integridade JSON]
