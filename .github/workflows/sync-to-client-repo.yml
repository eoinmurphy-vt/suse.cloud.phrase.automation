name: Sync Changes to External Repos

on:
  # Listen for Postprocess to finish successfully
  workflow_run:
    workflows: ["Postprocess Translated Files"]
    types:
      - completed
  
  workflow_dispatch:

jobs:
  deliver:
    # Safety Check: Only run if Postprocess succeeded or if triggered manually
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Dynamically checkout the branch that triggered Postprocess (e.g., dev)
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name }}

      - name: Load Configuration
        run: |
          mkdir -p config
          
          # Check the dynamic branch name
          CURRENT_BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          echo "Running on branch: $CURRENT_BRANCH"
          
          if [ "$CURRENT_BRANCH" == "dev" ]; then
            echo '${{ vars.SUSE_CLIENT_CONFIGURATION_DEV }}' > config/clients.json
          else
            echo '${{ vars.SUSE_CLIENT_CONFIGURATION }}' > config/clients.json
          fi
          
          if ! jq . config/clients.json >/dev/null 2>&1; then
             echo "❌ Error: Client configuration contains invalid JSON."
             exit 1
          fi

      - name: Distribute Files
        env:
          EXT_PAT: ${{ secrets.SUSE_PHRASE_CLIENT_WRITE_PAT }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          CONFIG_FILE="config/clients.json"

          for REPO_DIR in final/*; do
            [ -d "$REPO_DIR" ] || continue
            
            CLIENT_ID=$(basename "$REPO_DIR")
            echo ">>> Processing delivery for: $CLIENT_ID"

            CLIENT_URL=$(jq -r ".[] | select(.id==\"$CLIENT_ID\") | .url" $CONFIG_FILE)
            TARGET_PATH=$(jq -r ".[] | select(.id==\"$CLIENT_ID\") | .target_path" $CONFIG_FILE)
            BRANCH=$(jq -r ".[] | select(.id==\"$CLIENT_ID\") | .branch" $CONFIG_FILE)

            if [ -z "$CLIENT_URL" ] || [ "$CLIENT_URL" == "null" ]; then
              echo "⚠ Warning: No configuration found for ID '$CLIENT_ID'. Skipping."
              continue
            fi
            
            TEMP_WS="workspace_$CLIENT_ID"
            rm -rf "$TEMP_WS"
            
            git clone --depth 1 --branch "$BRANCH" "https://$EXT_PAT@github.com/$CLIENT_URL.git" "$TEMP_WS"
            
            mkdir -p "$TEMP_WS/$(dirname "$TARGET_PATH")"
            rsync -av "$REPO_DIR/" "$TEMP_WS/$TARGET_PATH/"
            
            cd "$TEMP_WS"
            git add .
            
            if git diff --cached --quiet; then
              echo "    No changes to push for $CLIENT_ID"
            else
              git commit -m "Translation Update: Delivered processed files"
              
              MAX_RETRIES=5
              count=0
              success=false
              until [ $count -ge $MAX_RETRIES ]; do
                if git push origin "$BRANCH"; then
                  success=true
                  break
                fi
                count=$((count+1))
                git fetch origin
                git rebase "origin/$BRANCH"
                sleep 5
              done

              if [ "$success" = true ]; then
                 echo "    ✅ Successfully pushed to $CLIENT_ID"
              else
                 echo "    ❌ Failed to push to $CLIENT_ID"
                 exit 1
              fi
            fi
            
            cd ..
            rm -rf "$TEMP_WS"
          done