name: Sync Changes from External Repos

on:
  schedule:
    # Schedule A: Runs Hourly (Matches 'hourly' group)
    - cron: '0 * * * *'
    # Schedule B: Runs Daily at Midnight (Matches 'daily' group)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      specific_repo_id:
        description: "Run for a specific Client ID (leave empty for all)"
        required: false
        type: string
      force_schedule_group:
        description: "Force specific schedule group (hourly/daily/all)"
        default: "all"
        required: false

jobs:
  # JOB 1: GENERATE MATRIX
  matrix-setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load Configuration
        id: load-config
        env:
          # Dynamically load config based on branch
          JSON_CONFIG: ${{ github.ref_name == 'dev' && vars.SUSE_CLIENT_CONFIGURATION_DEV || vars.SUSE_CLIENT_CONFIGURATION }}
        run: |
          mkdir -p config
          echo "$JSON_CONFIG" > config/clients.json
          
          if ! jq . config/clients.json >/dev/null 2>&1; then
             echo "❌ Error: Client configuration contains invalid JSON."
             jq . config/clients.json
             exit 1
          fi
          echo "✅ Configuration loaded successfully."

      - id: set-matrix
        name: Generate Job Matrix
        env:
          TRIGGER_SCHEDULE: ${{ github.event.schedule }}
          EVENT_NAME: ${{ github.event_name }}
          SPECIFIC_ID: ${{ inputs.specific_repo_id }}
          FORCE_GROUP: ${{ inputs.force_schedule_group }}
        run: |
          if [ "$EVENT_NAME" == "schedule" ]; then
            if [ "$TRIGGER_SCHEDULE" == "0 * * * *" ]; then TARGET_GROUP="hourly"
            elif [ "$TRIGGER_SCHEDULE" == "0 0 * * *" ]; then TARGET_GROUP="daily"
            else TARGET_GROUP="all"
            fi
          else
            TARGET_GROUP="${FORCE_GROUP:-all}"
          fi
          
          if [ -n "$SPECIFIC_ID" ]; then
             JSON=$(jq -c --arg id "$SPECIFIC_ID" 'map(select(.id == $id))' config/clients.json)
          elif [ "$TARGET_GROUP" != "all" ]; then
             JSON=$(jq -c --arg group "$TARGET_GROUP" 'map(select(.schedule == $group))' config/clients.json)
          else
             JSON=$(jq -c . config/clients.json)
          fi

          if [ "$JSON" == "[]" ] || [ -z "$JSON" ]; then
            echo "Warning: Matrix is empty. No jobs will run."
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            echo "matrix=$JSON" >> $GITHUB_OUTPUT
          fi

  # JOB 2: SYNC CLIENTS (PARALLEL)
  sync-client:
    needs: matrix-setup
    if: needs.matrix-setup.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        client: ${{ fromJson(needs.matrix-setup.outputs.matrix) }}
    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4

      - name: Sync Logic
        env:
          # Matrix values come directly from the JSON variable
          CLIENT_ID: ${{ matrix.client.id }}
          CLIENT_URL: ${{ matrix.client.url }}
          CLIENT_BRANCH: ${{ matrix.client.branch }}
          WATCH_PATH: ${{ matrix.client.watch_path }}
          
          # 1. Map the new exclude_paths variable
          EXCLUDE_PATHS: ${{ matrix.client.exclude_paths }}
          
          EXT_PAT: ${{ secrets.SUSE_PHRASE_CLIENT_WRITE_PAT }}
          # Token to write back to THIS repo (triggering downstream workflows)
          WRITE_PAT: ${{ secrets.VISTATEC_REPO_WRITE_PAT }}
          CURRENT_REPO: ${{ vars.CURRENT_REPO_NAME || github.repository }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git clone --depth 1 --branch "$CLIENT_BRANCH" "https://$EXT_PAT@github.com/$CLIENT_URL.git" temp_client
          
          # Define Local Target (Namespaced)
          LOCAL_TARGET="source/$CLIENT_ID"
          mkdir -p "$LOCAL_TARGET"

          # 2. Build Rsync Exclude Arguments dynamically
          RSYNC_EXCLUDES=""
          for path in $EXCLUDE_PATHS; do
            RSYNC_EXCLUDES="$RSYNC_EXCLUDES --exclude=$path"
          done
          
          rsync -av --delete $RSYNC_EXCLUDES --include='*.adoc' --include='*/' --exclude='*' "temp_client/$WATCH_PATH" "$LOCAL_TARGET/"
          
          git add "$LOCAL_TARGET"
          
          if git diff --cached --quiet; then
            echo "No changes for $CLIENT_ID"
            echo "CHANGED=false" >> $GITHUB_ENV
            exit 0
          fi

          git commit -m "Sync content from $CLIENT_ID"
          
          # Push with WRITE_PAT to trigger downstream pipelines
          git remote set-url origin https://$WRITE_PAT@github.com/$CURRENT_REPO.git
          
          MAX_RETRIES=10
          count=0
          # Dynamically push to the correct branch
          until git push origin ${{ github.ref_name }}; do
            if [ $count -ge $MAX_RETRIES ]; then exit 1; fi
            count=$((count+1))
            git pull --rebase origin ${{ github.ref_name }}
            sleep $((RANDOM % 10 + 2))
          done
          
          echo "CHANGED=true" >> $GITHUB_ENV